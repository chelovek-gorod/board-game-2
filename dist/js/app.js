(()=>{"use strict";var t={d:(e,i)=>{for(var s in i)t.o(i,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:i[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};t.d({},{H:()=>B});const e={menuLogo:"MarsGameLogoDarkBg.png",menuButton:"options_button_128x128px.png",menuButtonLock:"options_button_lock_128x128px.png",menuPlayer:"use_player_128x128px.png",menuComputer:"use_computer_128x128px.png",menuNoUser:"use_no_128x128px.png",menuRandom:"use_random_128x128px.png",menuMusicOn:"options_music_on_128x128px.png",menuMusicOff:"options_music_off_128x128px.png",menuEffectsOn:"options_effects_on_128x128px.png",menuEffectsOff:"options_effects_off_128x128px.png",board:"board.svg",dice:"dices_84x84px_mixed_frames.png",dicePointer:"pointer_dice_160x160px.png",pointerPlayerH:"turn_bw_480x120px_32frames.png",pointerPlayerV:"turn_bw_120x480px_32frames.png",tokenPointerHuman:"pointer_token_human_160x160px.png",tokenPointerBot:"pointer_token_bot_160x160px.png",tokenBomb:"token_bomb_128x128px.png",tokenButton:"token_button_128x128px.png",tokenCap:"token_cap_128x128px.png",tokenCoin:"token_coin_128x128px.png",tokenCrystal:"token_crystal_128x128px.png",tokenDragon:"token_dragon_128x128px.png",tokenEye:"token_eye_128x128px.png",tokenHelmet:"token_helmet_128x128px.png",tokenMask:"token_mask_128x128px.png",tokenMolecule:"token_molecule_128x128px.png",tokenMoon:"token_moon_128x128px.png",tokenNut:"token_nut_128x128px.png",tokenPlane:"token_plane_128x128px.png",tokenShark:"token_shark_128x128px.png",tokenShield:"token_shield_128x128px.png",tokenSkull:"token_skull_128x128px.png",tokenStone:"token_stone_128x128px.png",tokenToy:"token_toy_128x128px.png",tokenUfo:"token_ufo_128x128px.png",tokenWheel:"token_wheel_128x128px.png"},i={dice:"se_dices.mp3",dice2:"se_dices2.mp3",startToken:"se_start_token.mp3",step0:"se_step_0.mp3",step1:"se_step_1.mp3",step2:"se_step_2.mp3",step3:"se_step_3.mp3",step4:"se_step_4.mp3",step5:"se_step_5.mp3",step6:"se_step_6.mp3"},s="0.0.21",h=120,a=20,n=2500,r=1e3,o=800,l=500,c=900;class d{static instance;constructor(){if(d.instance)return d.instance;this.canvas=document.getElementById("canvas"),this.width=this.canvas.width=15*h+2*a,this.height=this.canvas.height=15*h+2*a,this.sizeRate=1,this.x=Math.round(this.width/2),this.y=Math.round(this.height/2),this.context=this.canvas.getContext("2d"),this.layers=[],d.instance=this,this.resize()}resize(){const t=innerWidth>innerHeight?innerHeight:innerWidth;this.sizeRate=this.width/t}getLayer(t){return this.layers.find((e=>e.name===t))}}const y=new d,x=document.getElementById("shell");u();let m=!0,p=!1;function u(){x.style.display="flex",x.innerHTML="<div><nobr>CLICK SCREEN</nobr> FOR <nobr>START GAME</nobr></div>"}function g(){u(),m=!1,cancelAnimationFrame(k),console.log("stop render")}document.body.onresize=()=>{y.resize(),document.fullscreenEnabled&&!document.fullscreenElement&&g()},x.onclick=()=>{x.style.display="none",m=!0,f=performance.now(),k=requestAnimationFrame(b),console.log("start render"),document.fullscreenEnabled&&!document.fullscreenElement&&document.body.requestFullscreen(),p||(p=!0,y.canvas.style.opacity=1)},document.body.onblur=g;let f=performance.now(),k=requestAnimationFrame(b);function b(t){const e=t-f;f=t,y.context.clearRect(0,0,y.width,y.height),y.layers.forEach((t=>t.update(e))),m&&(k=requestAnimationFrame(b))}const P=y,I=[1,1],w=class{constructor(t,i){this.img=e.dice,this.x=t-42,this.y=i-42,this.frameSize=84,this.throwDuration=r,this.fps=30,this.frameDuration=Math.floor(1e3/this.fps),this.frameTimeout=this.frameDuration,this.framePathSize=Math.floor(this.throwDuration/this.frameDuration),this.framePath=[],this.framePoint={x:0,y:0},this.value=this.getNewValue(),this.pointer=new class{constructor(t){this.image=e.dicePointer,this.x=t.x+41,this.y=t.y+41,this.scaleDuration=o/2,this.maxSize=160,this.minSize=80,this.scaleRate=(this.maxSize-this.minSize)/this.scaleDuration,this.isScaleUp=!0,this.size=this.minSize,this.halfSize=this.size/2}setMinSize(){this.size=this.minSize,this.halfSize=this.size/2}update(t){this.isScaleUp?(this.size+=this.scaleRate*t,this.size>=this.maxSize&&(this.isScaleUp=!1)):(this.size-=this.scaleRate*t,this.size<=this.minSize&&(this.isScaleUp=!0)),this.halfSize=this.size/2,P.context.drawImage(this.image,this.x-this.halfSize,this.y-this.halfSize,this.size,this.size)}}(this),this.isActive=!1}getNewValue(){const t=I.length?I.shift():Math.ceil(6*Math.random());switch(t){case 1:this.framePoint.x=0,this.framePoint.y=Math.random()<.5?4*this.frameSize:12*this.frameSize;break;case 2:this.framePoint.x=4*this.frameSize,this.framePoint.y=Math.random()<.5?4*this.frameSize:12*this.frameSize;break;case 5:this.framePoint.x=12*this.frameSize,this.framePoint.y=Math.random()<.5?4*this.frameSize:12*this.frameSize;break;case 6:this.framePoint.x=8*this.frameSize,this.framePoint.y=Math.random()<.5?4*this.frameSize:12*this.frameSize;break;case 3:this.framePoint.x=4*Math.floor(4*Math.random())*this.frameSize,this.framePoint.y=0;break;case 4:this.framePoint.x=4*Math.floor(4*Math.random())*this.frameSize,this.framePoint.y=8*this.frameSize;break;default:console.warn("error in dice value")}return t}throw(){if(this.framePath.length)return 0;let t="";for(;t.length<this.framePathSize;)t+=(""+Math.random()).slice(2);this.value=this.getNewValue(),this.framePath.push(this.framePoint);let e=Math.floor(8*Math.random()),{x:i,y:s}=this.framePoint;const h=15*this.frameSize;for(let a=0;a<this.framePathSize;a++)0!==e&&4!==e&&(i+=e<4?this.frameSize:-this.frameSize,i<0&&(i=h),i>h&&(i=0)),2!==e&&6!==e&&(s+=e>2&&e<6?this.frameSize:-this.frameSize,s<0&&(s=h),s>h&&(s=0)),this.framePath.push({x:i,y:s}),+t[a]<2&&(e--,e<0&&(e=7)),+t[a]>7&&(e++,e>7&&(e=0))}update(t){this.isActive&&this.pointer.update(t),this.framePath.length&&(this.frameTimeout-=t,this.frameTimeout<=0&&(this.frameTimeout+=this.frameDuration,this.framePoint=this.framePath.pop())),P.context.drawImage(this.img,this.framePoint.x,this.framePoint.y,this.frameSize,this.frameSize,this.x,this.y,this.frameSize,this.frameSize)}};let z=0;const S=class{constructor(t="",e=P.layers.length,i=[]){this.name=t||"layer"+z++,this.zIndex=e,this.objects=i,e===P.layers.length?P.layers.push(this):(P.layers.splice(e,0,this),P.layers.forEach(((t,e)=>t.zIndex=e)))}update(t){this.objects.forEach((e=>e.update(t)))}remove(t){this.objects=this.objects.filter((e=>e!==t))}add(t){this.objects.push(t)}moveUp(t){this.objects=this.objects.filter((e=>e!==t)),this.objects.push(t)}clear(){this.objects=[]}},T=class{constructor(t,e){this.callback=t,this.milliseconds=e,P.layers[0].add(this)}update(t){this.milliseconds-=t,this.milliseconds<=0&&(setTimeout((()=>this.callback()),0),P.layers[0].remove(this))}},v=class{constructor(t){this.player=t,this.image=t.tokenImage,this.maxSize=128,this.minSize=96,this.size=this.minSize,this.halfSize=this.size/2,this.startPoint=t.startPoint,this.reserve=B.board.reserves[t.startPoint],this.home=B.board.homes[t.startPoint],this.container=this.reserve,this.index=this.player.tokens.length,this.x=this.container[this.index].x,this.y=this.container[this.index].y,this.stepDuration=l,this.halfStepDuration=this.stepDuration/2,this.sizeRate=(this.maxSize-this.minSize)/this.halfStepDuration,this.stepTimeout=this.stepDuration,this.speed=0,this.steps=0,this.direction=0,this.target=null,this.path=[],this.isGoHome=!1,this.isBot=t.isBot,this.pointer=new class{constructor(t,i){this.image=i?e.tokenPointerBot:e.tokenPointerHuman,this.scaleDuration=c,this.maxSize=148,this.minSize=120,this.size=this.minSize+(this.maxSize-this.minSize)/4*t,this.halfSize=this.size/2,this.scaleRate=(this.maxSize-this.minSize)/this.scaleDuration,this.direction=0,this.isScaleUp=!0}draw(t,e){this.isScaleUp?(this.size+=this.scaleRate*e,this.size>=this.maxSize&&(this.isScaleUp=!1,this.size=this.maxSize)):(this.size-=this.scaleRate*e,this.size<=this.minSize&&(this.isScaleUp=!0,this.size=this.minSize)),this.halfSize=this.size/2,P.context.drawImage(this.image,t.x-this.halfSize,t.y-this.halfSize,this.size,this.size)}}(this.index,this.isBot),this.isAvailable=!1,this.isActive=!1}checkCeilAllTokens(t,e){const i=B.players.length;for(let s=0;s<i;s++){const i=this.checkCeilPlayerTokens(t,e,B.players[s]);if(i)return i}return!1}checkCeilPlayerTokens(t,e,i=this.player){const s=i.tokens.length;for(let h=0;h<s;h++){const s=i.tokens[h];if(s.container===t&&s.index===e&&s!==this)return s}return!1}getPath(t){switch(this.path=[],this.container){case this.reserve:this.checkPathFromReserve(t);break;case B.board.toiletTop:case B.board.toiletRight:case B.board.toiletBottom:case B.board.toiletLeft:this.checkPathInToilet(t);break;case this.home:this.checkPathInHome(t);break;default:this.checkPathInMainBoard(t)}this.path.length?this.isAvailable=!0:this.isAvailable=!1}checkPathFromReserve(t){6===t&&(this.checkCeilPlayerTokens(B.board.ceils,this.reserve[0].targetIndex)||(this.isGoHome=!1,this.addPathPoint(B.board.ceils,this.reserve[0].targetIndex)))}checkPathInToilet(t){t===this.container[this.index].move&&("targetIndex"in this.container[this.index]?this.addPathPoint(B.board.ceils,this.container[this.index].targetIndex):this.addPathPoint(this.container,this.index+1))}checkPathInHome(t,e=this.index){console.log(t,e);const i=this.home.length-1-e;if(i<=0||t>i)return this.path=[];const s=e+t;for(let t=e+1;t<=s;t++){if(this.checkCeilPlayerTokens(this.home,t))return this.path=[];this.addPathPoint(this.home,t)}console.log("path after inrty home",[...this.path])}checkPathInMainBoard(t){if(this.isGoHome&&"home"===B.board.ceils[this.index].type&&B.board.ceils[this.index].targetIndex===this.startPoint)return this.checkCeilPlayerTokens(this.home,0)?this.path=[]:(this.addPathPoint(this.home,0),void this.checkPathInHome(t-1,0));let e=this.isGoHome,i=this.index;for(;t>0;){i++,i>=B.board.ceils.length&&(i=0);const s=this.container[i].type;if("corner"===s&&this.checkCeilAllTokens(B.board.ceils,i))return this.path=[];if("home"===s&&e&&B.board.ceils[i].targetIndex===this.startPoint)return this.checkCeilAllTokens(B.board.ceils,i)||this.checkCeilPlayerTokens(this.home,0)?this.path=[]:(this.addPathPoint(B.board.ceils,i),void(t>1&&(this.addPathPoint(this.home,0),t>2&&this.checkPathInHome(t-2,0))));if(t>1){if(this.checkCeilAllTokens(B.board.ceils,i))return this.path=[];this.addPathPoint(B.board.ceils,i)}else{if(this.checkCeilPlayerTokens(B.board.ceils,i))return this.path=[];switch(s){case"port":const t=B.board.ceils[i].targetIndex,e=B.board.ports[t].targetIndex;if(this.checkCeilPlayerTokens(B.board.ceils,e))return this.path=[];this.addPathPoint(B.board.ceils,i),this.addPathPoint(B.board.ports,t),this.addPathPoint(B.board.ceils,e);break;case"toilet":const s=B.board.ceils[i].targetIndex;this.addPathPoint(B.board.ceils,i),this.addPathPoint(B.board.toilets[s],0);break;default:this.addPathPoint(B.board.ceils,i)}}t--}}addPathPoint(t,e){this.path.push({container:t,index:e,x:t[e].x,y:t[e].y})}pushPathInToilet(){console.log("pushPathInToilet"),this.path=[],"targetIndex"in this.container[this.index]?this.addPathPoint(B.board.ceils,this.container[this.index].targetIndex):this.addPathPoint(this.container,this.index+1),this.startStep(),console.log({...this})}pushPathToReserve(){console.log("pushPathToReserve"),this.path=[];const t=this.reserve.length,e=new Array(t);this.player.tokens.forEach((t=>{t.container===this.reserve&&(e[t.index]=!0)}));for(let i=0;i<t;i++)if(!e[i]){this.addPathPoint(this.reserve,i);break}this.startStep(),console.log({...this})}activation(){this.isAvailable&&(this.player.tokens.forEach((t=>t.isAvailable=!1)),this.isActive=!0,this.startStep())}startStep(){if(this.player.layer.moveUp(this),this.target=this.path.shift(),this.target.container===B.board.toiletTop||this.target.container===B.board.toiletRight||this.target.container===B.board.toiletBottom||this.target.container===B.board.toiletLeft){const t=this.checkCeilAllTokens(this.target.container,this.target.index);t&&t.pushPathInToilet()}this.setDirection();const t=this.getDistance();this.speed=t/this.stepDuration,this.container===this.reserve&&i.startToken.play()}setDirection(){this.direction=Math.atan2(this.target.y-this.y,this.target.x-this.x)}getDistance(){let t=this.target.x-this.x,e=this.target.y-this.y;return Math.sqrt(t*t+e*e)}move(t){this.x+=Math.cos(this.direction)*t,this.y+=Math.sin(this.direction)*t}endStep(){if(this.size=this.minSize,this.halfSize=this.size/2,this.stepTimeout=this.stepDuration,this.container=this.target.container,this.index=this.target.index,this.x=this.target.x,this.y=this.target.y,this.target=null,this.container===B.board.ceils){const t=this.checkCeilAllTokens(B.board.ceils,this.index);t&&t.pushPathToReserve()}i["step"+Math.floor(7*Math.random())].play(),this.path.length?this.startStep():this.endMove()}endMove(){if(this.isGoHome||this.container===B.board.ceils&&this.index===this.reserve[0].targetIndex||(this.isGoHome=!0),this.container===this.home){let t=!0;this.player.tokens.forEach((e=>{e.container!==this.home&&(t=!1)})),t&&(B.isEnd=!0)}if(this.container===B.board.ceils&&"corner"===this.container[this.index].type){let t=!0;this.player.tokens.forEach((e=>{e.container===B.board.ceils&&"corner"===e.container[e.index].type||(t=!1)})),t&&(B.isEnd=!0)}this.isActive&&(this.isActive=!1,new T((()=>this.player.diceFinished()),1e3))}update(t){this.isAvailable&&this.pointer.draw({x:this.x,y:this.y},t),this.target&&(this.stepTimeout-=t,this.stepTimeout>this.halfStepDuration?this.size+=this.sizeRate*t:this.size-=this.sizeRate*t,this.halfSize=this.size/2,this.stepTimeout>0?this.move(t*this.speed):this.endStep()),P.context.drawImage(this.image,this.x-this.halfSize,this.y-this.halfSize,this.size,this.size)}},X=class{constructor(t,i,s){this.getPointerPosition(i),this.image=i%2==0?e.pointerPlayerH:e.pointerPlayerV,this.tokenImage=t,this.frameWidth=i%2==0?480:120,this.frameHeight=i%2==0?120:480,this.frame=0,this.fps=30,this.frameDuration=Math.floor(1e3/this.fps),this.frameTimeout=this.frameDuration,this.frames=this.getFrames(),this.dices=[],this.dice=null,this.isGetDouble=!1,this.startPoint=i,this.tokens=[],this.isBot=s,this.layer=P.getLayer("players"),this.generateTokens()}getPointerPosition(t){t%2==0?(this.x=a+5.5*h,this.y=0===t?a:a+14*h):(this.y=a+5.5*h,this.x=3===t?a:a+14*h)}getFrames(){const t=[];for(let e=0;e<this.image.height;e+=this.frameHeight)for(let i=0;i<this.image.width;i+=this.frameWidth)t.push({x:i,y:e});return t}generateTokens(){const t=P.getLayer("tokens");for(let e=0;e<4;e++){const e=new v(this);this.tokens.push(e),t.add(e)}}startTurn(){this.layer.add(this),this.throwDices()}throwDices(){i.dice2.play(),B.dices.forEach((t=>t.throw())),this.isGetDouble=B.dices[0].value===B.dices[1].value,B.dices[0].value>=B.dices[1].value?this.dices=[1,0]:this.dices=[0,1],new T((()=>this.useDice()),r)}useDice(){this.dice=B.dices[this.dices.pop()],this.dice.isActive=!0;const t=[];this.tokens.forEach((e=>{e.getPath(this.dice.value),e.isAvailable&&t.push(e)})),t.length?this.isBot&&this.botActivation(t.sort((()=>Math.random()-.5))):new T((()=>this.diceFinished()),o)}botActivation(t){new T((()=>t[0].activation()),o)}diceFinished(){this.dice.isActive=!1,this.dice.pointer.setMinSize(),this.dices.length&&!B.isEnd?this.useDice():this.isGetDouble&&!B.isEnd?this.throwDices():this.endTurn()}endTurn(){this.layer.remove(this),B.nextTurn()}update(t){this.frameTimeout-=t,this.frameTimeout<=0&&(this.frameTimeout+=this.frameDuration,this.frame++,this.frame===this.frames.length&&(this.frame=0)),P.context.drawImage(this.image,this.frames[this.frame].x,this.frames[this.frame].y,this.frameWidth,this.frameHeight,this.x,this.y,this.frameWidth,this.frameHeight)}},Y=class{constructor(t="",e=0,i=0,s){this.x=e,this.y=i,this.weight=s.weight||"normal",this.style=s.style||"normal",this.size=s.size||24,this.family=s.family||"Arial",this.color=s.color||"#00ff00",this.strokeColor=s.strokeColor||"#00000000",this.strokeWidth=s.strokeWidth||0,this.align=s.align?this.getTextAlign(s.align):"left",this.offsetX=0,this.font=`${this.weight} ${this.style} ${this.size}px ${this.family}, Arial, sans-serif`,this.img=document.createElement("canvas"),this.ctx=this.img.getContext("2d"),this.img.width=this.getTextWidth(t),this.img.height=this.size,this.isExist=!0,this.render(t)}getTextAlign(t){switch(t){case"right":return"right";case"center":return"center";default:return"left"}}getTextWidth(t){return this.ctx.font=this.font,this.ctx.measureText(t||" ").width}render(t){this.ctx.clearRect(0,0,this.img.width,this.img.height),this.img.width=this.getTextWidth(t),"right"===this.align&&(this.offsetX=this.img.width),"center"===this.align&&(this.offsetX=Math.floor(this.img.width/2)),this.ctx.font=this.font,this.ctx.textBaseline="top",this.ctx.textAlign=this.align,this.ctx.fillStyle=this.color,this.ctx.fillText(t||" ",this.offsetX,0),this.strokeWidth&&(this.ctx.strokeStyle=this.strokeColor,this.ctx.lineWidth=this.strokeWidth,this.ctx.strokeText(t||" ",this.offsetX,0))}draw(t){t.drawImage(this.img,this.x-this.offsetX,this.y)}};!function(t){let h=Object.keys(e).length+Object.keys(i).length;for(const t in e){const i=new Image;i.src="./src/images/"+e[t],i.onload=()=>{e[t]=i,a()}}for(const t in i){const e=new Audio("./src/sounds/"+i[t]);e.oncanplaythrough=s=>{s.target.oncanplaythrough=null,i[t]=e,a()}}function a(){h--,h||(B.tokens=[e.tokenBomb,e.tokenButton,e.tokenCap,e.tokenCoin,e.tokenCrystal,e.tokenDragon,e.tokenEye,e.tokenHelmet,e.tokenMask,e.tokenMolecule,e.tokenMoon,e.tokenNut,e.tokenPlane,e.tokenShark,e.tokenShield,e.tokenSkull,e.tokenStone,e.tokenToy,e.tokenUfo,e.tokenWheel],B.menu=new class{constructor(t,e){this.startGameCallback=t,this.state=e||{players:[{isUsed:!0,isBot:!1,tokenIndex:2},{isUsed:!0,isBot:!0,tokenIndex:11},{isUsed:!0,isBot:!0,tokenIndex:1},{isUsed:!1,isBot:!0,tokenIndex:1/0}],tokens:B.tokens.map(((t,e)=>e)),music:!0,effects:!0,start:!0},this.state.players.forEach((t=>{this.state.tokens=this.state.tokens.filter((e=>t.tokenIndex!==e))})),this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.canvas.width=P.width,this.canvas.height=P.height,this.underlay={width:720,height:180},this.button={width:180,height:180},this.underlay1={x:120,y:P.y-270},this.underlay2={x:P.x+60,y:P.y-270},this.underlay3={x:120,y:P.y+90},this.underlay4={x:P.x+60,y:P.y+90},this.btnP1User={x:this.underlay1.x+90,y:this.underlay1.y,width:this.button.width,height:this.button.height},this.btnP1Token={x:this.underlay1.x+450,y:this.underlay1.y,width:this.button.width,height:this.button.height},this.btnP2User={x:this.underlay2.x+90,y:this.underlay2.y,width:this.button.width,height:this.button.height},this.btnP2Token={x:this.underlay2.x+450,y:this.underlay2.y,width:this.button.width,height:this.button.height},this.btnP3User={x:this.underlay3.x+90,y:this.underlay3.y,width:this.button.width,height:this.button.height},this.btnP3Token={x:this.underlay3.x+450,y:this.underlay3.y,width:this.button.width,height:this.button.height},this.btnP4User={x:this.underlay4.x+90,y:this.underlay4.y,width:this.button.width,height:this.button.height},this.btnP4Token={x:this.underlay4.x+450,y:this.underlay4.y,width:this.button.width,height:this.button.height},this.btnMusic={x:this.underlay3.x+90,y:this.underlay3.y+360,width:this.button.width,height:this.button.height},this.btnEffects={x:this.underlay4.x+450,y:this.underlay4.y+360,width:this.button.width,height:this.button.height},this.btnStart={x:P.x-360,y:this.underlay4.y+360,width:this.underlay.width,height:this.underlay.height},this.buttonText=new Y("START",this.btnStart.x+360,this.btnStart.y+10,{size:140,family:"clip",weight:"600",color:"#ff00bc",align:"center"}),this.labelText=new Y("PARCHIS",P.x,P.y-960,{size:540,family:"clip",weight:"600",color:"#00f66c",align:"center"}),this.versionText=new Y(`VERSION: ${s}`,160,this.canvas.height-70,{size:68,family:"clip",weight:"600",color:"#ffffff",align:"left"}),this.render()}getPlayerImage(t){return this.state.players[t].isUsed?this.state.players[t].isBot?e.menuComputer:e.menuPlayer:e.menuNoUser}getTokenImage(t){if(!this.state.players[t].isUsed||this.state.players[t].tokenIndex>=B.tokens.length)return e.menuRandom;const i=this.state.players[t].tokenIndex;return B.tokens[i]}render(){this.updateStateStart(),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.labelText.draw(this.context),this.context.drawImage(e.pointerPlayerH,0,0,480,120,this.underlay1.x,this.underlay1.y,this.underlay.width,this.underlay.height),this.context.drawImage(e.pointerPlayerH,0,0,480,120,this.underlay2.x,this.underlay2.y,this.underlay.width,this.underlay.height),this.context.drawImage(e.pointerPlayerH,0,0,480,120,this.underlay3.x,this.underlay3.y,this.underlay.width,this.underlay.height),this.context.drawImage(e.pointerPlayerH,0,0,480,120,this.underlay4.x,this.underlay4.y,this.underlay.width,this.underlay.height),this.context.drawImage(this.getPlayerImage(0),this.btnP1User.x,this.btnP1User.y,this.button.width,this.button.height),this.context.drawImage(this.getTokenImage(0),this.btnP1Token.x,this.btnP1Token.y,this.button.width,this.button.height),this.context.drawImage(this.getPlayerImage(1),this.btnP2User.x,this.btnP2User.y,this.button.width,this.button.height),this.context.drawImage(this.getTokenImage(1),this.btnP2Token.x,this.btnP2Token.y,this.button.width,this.button.height),this.context.drawImage(this.getPlayerImage(2),this.btnP3User.x,this.btnP3User.y,this.button.width,this.button.height),this.context.drawImage(this.getTokenImage(2),this.btnP3Token.x,this.btnP3Token.y,this.button.width,this.button.height),this.context.drawImage(this.getPlayerImage(3),this.btnP4User.x,this.btnP4User.y,this.button.width,this.button.height),this.context.drawImage(this.getTokenImage(3),this.btnP4Token.x,this.btnP4Token.y,this.button.width,this.button.height),this.context.drawImage(this.state.music?e.menuMusicOn:e.menuMusicOff,this.btnMusic.x,this.btnMusic.y,this.button.width,this.button.height),this.context.drawImage(this.state.start?e.menuButton:e.menuButtonLock,this.btnStart.x,this.btnStart.y,this.underlay.width,this.underlay.height),this.context.drawImage(this.state.effects?e.menuEffectsOn:e.menuEffectsOff,this.btnEffects.x,this.btnEffects.y,this.button.width,this.button.height),this.buttonText.draw(this.context),this.context.drawImage(e.menuLogo,P.x+240,this.canvas.height-160),this.versionText.draw(this.context)}checkClickButton(t,e,i){return t>i.x&&t<i.x+i.width&&e>i.y&&e<i.y+i.height}click(t,e){this.checkClickButton(t,e,this.btnStart)&&this.state.start&&this.startGame(),this.checkClickButton(t,e,this.btnMusic)&&(this.state.music=!this.state.music,this.render()),this.checkClickButton(t,e,this.btnEffects)&&(this.state.effects=!this.state.effects,this.render()),this.checkClickButton(t,e,this.btnP1User)&&this.clickPlayer(0),this.checkClickButton(t,e,this.btnP1Token)&&this.clickToken(0),this.checkClickButton(t,e,this.btnP2User)&&this.clickPlayer(1),this.checkClickButton(t,e,this.btnP2Token)&&this.clickToken(1),this.checkClickButton(t,e,this.btnP3User)&&this.clickPlayer(2),this.checkClickButton(t,e,this.btnP3Token)&&this.clickToken(2),this.checkClickButton(t,e,this.btnP4User)&&this.clickPlayer(3),this.checkClickButton(t,e,this.btnP4Token)&&this.clickToken(3)}updateStateStart(){let t=0;this.state.players.forEach((e=>{e.isUsed&&t++})),this.state.start=t>1}clickPlayer(t){this.state.players[t].isUsed?this.state.players[t].isBot?(this.state.players[t].isUsed=!1,this.state.players[t].isBot=!1,isFinite(this.state.players[t].tokenIndex)&&(this.state.tokens.push(this.state.players[t].tokenIndex),this.state.players[t].tokenIndex=1/0)):this.state.players[t].isBot=!0:this.state.players[t].isUsed=!0,this.render()}clickToken(t){if(!this.state.players[t].isUsed)return this.state.players[t].isUsed=!0,this.render();isFinite(this.state.players[t].tokenIndex)&&this.state.tokens.push(this.state.players[t].tokenIndex),this.state.players[t].tokenIndex=this.state.tokens.shift(),this.render()}startGame(){this.state.players.forEach((t=>{isFinite(t.tokenIndex)||(this.state.tokens.sort((()=>Math.random()-.5)),t.tokenIndex=this.state.tokens.pop())})),P.canvas.style.opacity=0,setTimeout((()=>{P.getLayer("menu").clear(),this.startGameCallback(this.state),setTimeout((()=>P.canvas.style.opacity=1),500)}),1e3)}update(){P.context.drawImage(this.canvas,0,0)}}(C),M.add(B.menu))}}(),new S("timers",0);const _=new S("board",1),E=new S("dices",2),M=(new S("players",3),new S("tokens",4),new S("menu",5)),B={tokens:[],menu:null,isStart:!1,players:[],currentTurn:0,board:null,dices:[],isEnd:!1,nextTurn(){if(this.isEnd)return this.end();this.currentTurn++,this.currentTurn===this.players.length&&(this.currentTurn=0),this.players[this.currentTurn].startTurn()},end(){document.querySelector("second").innerHTML=`PLAYER ${this.currentTurn} WIN!`}};function C(t){B.isStart=!0,B.board=new class{constructor(){this.image=e.board,this.ceilSize=h,this.imageSize=13*this.ceilSize,this.imageOffset=a+h,this.reserveTop=[{isEmpty:!0,targetIndex:6,x:0,y:0,rateX:5.5,rateY:0},{isEmpty:!0,targetIndex:6,x:0,y:0,rateX:6.5,rateY:0},{isEmpty:!0,targetIndex:6,x:0,y:0,rateX:7.5,rateY:0},{isEmpty:!0,targetIndex:6,x:0,y:0,rateX:8.5,rateY:0}],this.reserveRight=[{isEmpty:!0,targetIndex:18,x:0,y:0,rateX:14,rateY:5.5},{isEmpty:!0,targetIndex:18,x:0,y:0,rateX:14,rateY:6.5},{isEmpty:!0,targetIndex:18,x:0,y:0,rateX:14,rateY:7.5},{isEmpty:!0,targetIndex:18,x:0,y:0,rateX:14,rateY:8.5}],this.reserveBottom=[{isEmpty:!0,targetIndex:30,x:0,y:0,rateX:5.5,rateY:14},{isEmpty:!0,targetIndex:30,x:0,y:0,rateX:6.5,rateY:14},{isEmpty:!0,targetIndex:30,x:0,y:0,rateX:7.5,rateY:14},{isEmpty:!0,targetIndex:30,x:0,y:0,rateX:8.5,rateY:14}],this.reserveLeft=[{isEmpty:!0,targetIndex:42,x:0,y:0,rateX:0,rateY:5.5},{isEmpty:!0,targetIndex:42,x:0,y:0,rateX:0,rateY:6.5},{isEmpty:!0,targetIndex:42,x:0,y:0,rateX:0,rateY:7.5},{isEmpty:!0,targetIndex:42,x:0,y:0,rateX:0,rateY:8.5}],this.reserves=[this.reserveTop,this.reserveRight,this.reserveBottom,this.reserveLeft],this.toiletTop=[{token:null,move:1,x:0,y:0,rateX:10,rateY:2},{token:null,move:3,x:0,y:0,rateX:11,rateY:2},{token:null,move:6,targetIndex:11,x:0,y:0,rateX:12,rateY:2}],this.toiletRight=[{token:null,move:1,x:0,y:0,rateX:12,rateY:10},{token:null,move:3,x:0,y:0,rateX:12,rateY:11},{token:null,move:6,targetIndex:23,x:0,y:0,rateX:12,rateY:12}],this.toiletBottom=[{token:null,move:1,x:0,y:0,rateX:4,rateY:12},{token:null,move:3,x:0,y:0,rateX:3,rateY:12},{token:null,move:6,targetIndex:35,x:0,y:0,rateX:2,rateY:12}],this.toiletLeft=[{token:null,move:1,x:0,y:0,rateX:2,rateY:4},{token:null,move:3,x:0,y:0,rateX:2,rateY:3},{token:null,move:6,targetIndex:47,x:0,y:0,rateX:2,rateY:2}],this.toilets=[this.toiletTop,this.toiletRight,this.toiletBottom,this.toiletLeft],this.homeTop=[{isEmpty:!0,targetIndex:6,x:0,y:0,rateX:7,rateY:2},{isEmpty:!0,targetIndex:6,x:0,y:0,rateX:7,rateY:3},{isEmpty:!0,targetIndex:6,x:0,y:0,rateX:7,rateY:4},{isEmpty:!0,targetIndex:6,x:0,y:0,rateX:7,rateY:5}],this.homeRight=[{isEmpty:!0,targetIndex:18,x:0,y:0,rateX:12,rateY:7},{isEmpty:!0,targetIndex:18,x:0,y:0,rateX:11,rateY:7},{isEmpty:!0,targetIndex:18,x:0,y:0,rateX:10,rateY:7},{isEmpty:!0,targetIndex:18,x:0,y:0,rateX:9,rateY:7}],this.homeBottom=[{isEmpty:!0,targetIndex:30,x:0,y:0,rateX:7,rateY:12},{isEmpty:!0,targetIndex:30,x:0,y:0,rateX:7,rateY:11},{isEmpty:!0,targetIndex:30,x:0,y:0,rateX:7,rateY:10},{isEmpty:!0,targetIndex:30,x:0,y:0,rateX:7,rateY:9}],this.homeLeft=[{isEmpty:!0,targetIndex:42,x:0,y:0,rateX:2,rateY:7},{isEmpty:!0,targetIndex:42,x:0,y:0,rateX:3,rateY:7},{isEmpty:!0,targetIndex:42,x:0,y:0,rateX:4,rateY:7},{isEmpty:!0,targetIndex:42,x:0,y:0,rateX:5,rateY:7}],this.homes=[this.homeTop,this.homeRight,this.homeBottom,this.homeLeft],this.ports=[{type:"topLeft",targetIndex:44,x:0,y:0,rateX:5,rateY:5},{type:"topRight",targetIndex:16,x:0,y:0,rateX:9,rateY:5},{type:"rightTop",targetIndex:8,x:0,y:0,rateX:9,rateY:5},{type:"rightBottom",targetIndex:28,x:0,y:0,rateX:9,rateY:9},{type:"bottomRight",targetIndex:20,x:0,y:0,rateX:9,rateY:9},{type:"bottomLeft",targetIndex:40,x:0,y:0,rateX:5,rateY:9},{type:"leftBottom",targetIndex:32,x:0,y:0,rateX:5,rateY:9},{type:"leftTop",targetIndex:4,x:0,y:0,rateX:5,rateY:5}],this.ceils=[{type:"corner",x:0,y:0,rateX:1,rateY:1},{type:"empty",x:0,y:0,rateX:2,rateY:1},{type:"empty",x:0,y:0,rateX:3,rateY:1},{type:"empty",x:0,y:0,rateX:4,rateY:1},{type:"port",targetIndex:0,x:0,y:0,rateX:5,rateY:1},{type:"empty",x:0,y:0,rateX:6,rateY:1},{type:"home",targetIndex:0,x:0,y:0,rateX:7,rateY:1},{type:"empty",x:0,y:0,rateX:8,rateY:1},{type:"port",targetIndex:1,x:0,y:0,rateX:9,rateY:1},{type:"toilet",targetIndex:0,x:0,y:0,rateX:10,rateY:1},{type:"empty",x:0,y:0,rateX:11,rateY:1},{type:"exit",x:0,y:0,rateX:12,rateY:1},{type:"corner",x:0,y:0,rateX:13,rateY:1},{type:"empty",x:0,y:0,rateX:13,rateY:2},{type:"empty",x:0,y:0,rateX:13,rateY:3},{type:"empty",x:0,y:0,rateX:13,rateY:4},{type:"port",targetIndex:2,x:0,y:0,rateX:13,rateY:5},{type:"empty",x:0,y:0,rateX:13,rateY:6},{type:"home",targetIndex:1,x:0,y:0,rateX:13,rateY:7},{type:"empty",x:0,y:0,rateX:13,rateY:8},{type:"port",targetIndex:3,x:0,y:0,rateX:13,rateY:9},{type:"toilet",targetIndex:1,x:0,y:0,rateX:13,rateY:10},{type:"empty",x:0,y:0,rateX:13,rateY:11},{type:"exit",x:0,y:0,rateX:13,rateY:12},{type:"corner",x:0,y:0,rateX:13,rateY:13},{type:"empty",x:0,y:0,rateX:12,rateY:13},{type:"empty",x:0,y:0,rateX:11,rateY:13},{type:"empty",x:0,y:0,rateX:10,rateY:13},{type:"port",targetIndex:4,x:0,y:0,rateX:9,rateY:13},{type:"empty",x:0,y:0,rateX:8,rateY:13},{type:"home",targetIndex:2,x:0,y:0,rateX:7,rateY:13},{type:"empty",x:0,y:0,rateX:6,rateY:13},{type:"port",targetIndex:5,x:0,y:0,rateX:5,rateY:13},{type:"toilet",targetIndex:2,x:0,y:0,rateX:4,rateY:13},{type:"empty",x:0,y:0,rateX:3,rateY:13},{type:"exit",x:0,y:0,rateX:2,rateY:13},{type:"corner",x:0,y:0,rateX:1,rateY:13},{type:"empty",x:0,y:0,rateX:1,rateY:12},{type:"empty",x:0,y:0,rateX:1,rateY:11},{type:"empty",x:0,y:0,rateX:1,rateY:10},{type:"port",targetIndex:6,x:0,y:0,rateX:1,rateY:9},{type:"empty",x:0,y:0,rateX:1,rateY:8},{type:"home",targetIndex:3,x:0,y:0,rateX:1,rateY:7},{type:"empty",x:0,y:0,rateX:1,rateY:6},{type:"port",targetIndex:7,x:0,y:0,rateX:1,rateY:5},{type:"toilet",targetIndex:3,x:0,y:0,rateX:1,rateY:4},{type:"empty",x:0,y:0,rateX:1,rateY:3},{type:"exit",x:0,y:0,rateX:1,rateY:2}],this.init()}init(){const t=.5*this.ceilSize+a;[...this.reserves,...this.toilets,...this.homes,this.ports,this.ceils].forEach((e=>{e.forEach((e=>{e.x=t+this.ceilSize*e.rateX,e.y=t+this.ceilSize*e.rateY}))}))}update(){P.context.drawImage(this.image,this.imageOffset,this.imageOffset,this.imageSize,this.imageSize)}},_.add(B.board),B.dices.push(new w(P.x-63,P.y-63)),B.dices.push(new w(P.x+63,P.y+63)),B.dices.forEach((t=>E.add(t)));for(let e=0;e<t.players.length;e++)if(t.players[e].isUsed){const i=t.players[e].tokenIndex,s=(e+2)%t.players.length;B.players.push(new X(B.tokens[i],s,t.players[e].isBot))}B.currentTurn=Math.floor(Math.random()*B.players.length),new T((()=>B.nextTurn()),n)}P.canvas.onclick=function(t){const e=t.offsetX*P.sizeRate,i=t.offsetY*P.sizeRate;B.isStart?function(t,e){if(B.players[B.currentTurn].isBot)return;const i=[];let s=!0;if(B.players[B.currentTurn].tokens.forEach((t=>{t.isAvailable&&(i.push(t),t.container!==t.reserve&&(s=!1))})),0!==i.length)if(1!==i.length){for(let s=0;s<i.length;s++){const a=t-i[s].x,n=e-i[s].y;if(Math.sqrt(a*a+n*n)<h/2)return i[s].activation()}s&&i[0].activation()}else i[0].activation()}(e,i):B.menu&&B.menu.click(e,i)}})();